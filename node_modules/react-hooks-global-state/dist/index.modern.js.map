{"version":3,"file":"index.modern.js","sources":["../src/createContainer.ts","../src/createGlobalState.ts","../src/createStore.ts","../src/devtools.ts"],"sourcesContent":["import {\n  Dispatch,\n  Reducer,\n  SetStateAction,\n  useCallback,\n  useEffect,\n  useReducer,\n  useRef,\n  useState,\n} from 'react';\n\n// utility functions\n\n// eslint-disable-next-line @typescript-eslint/ban-types\nconst isFunction = (fn: unknown): fn is Function => (typeof fn === 'function');\n\nconst updateValue = <Value>(oldValue: Value, newValue: SetStateAction<Value>) => {\n  if (isFunction(newValue)) {\n    return newValue(oldValue);\n  }\n  return newValue;\n};\n\nconst validateStateKey = (keys: string[], stateKey: string) => {\n  if (!keys.includes(stateKey)) {\n    throw new Error(`'${stateKey}' not found. It must be provided in initialState as a property key.`);\n  }\n};\n\n// constants\n\nconst UPDATE_STATE = (\n  process.env.NODE_ENV !== 'production' ? Symbol('UPDATE_STATE')\n  /* for production */ : Symbol()\n);\n\nconst PROP_UPDATER = 'r';\nconst PROP_STATE = 'e';\n\n// createContainer\n\nexport const createContainer = <State, Action>(\n  reducer: Reducer<State, Action>,\n  initialState: State,\n) => {\n  type StateKeys = keyof State;\n  const keys = Object.keys(initialState);\n\n  let globalState = initialState;\n\n  type PA1 = { type: typeof UPDATE_STATE; [PROP_UPDATER]: (prev: State) => State };\n  type PA2 = { type: typeof UPDATE_STATE; [PROP_STATE]: State };\n  type PatchAction = PA1 | PA2;\n  let linkedDispatch: Dispatch<Action | PatchAction> | null = null;\n\n  const listeners = {} as {\n    [StateKey in StateKeys]: Set<Dispatch<SetStateAction<State[StateKey]>>>;\n  };\n  keys.forEach((key) => { listeners[key as StateKeys] = new Set(); });\n\n  const patchedReducer = (state: State, action: Action | PatchAction) => {\n    // how can it be typed more properly?\n    if ((action as { type: unknown }).type === UPDATE_STATE) {\n      return (action as { [PROP_UPDATER]: unknown })[PROP_UPDATER]\n        ? (action as PA1)[PROP_UPDATER](state)\n        : (action as PA2)[PROP_STATE];\n    }\n    return reducer(state, action as Action);\n  };\n\n  const setGlobalState = <StateKey extends StateKeys>(\n    stateKey: StateKey,\n    update: SetStateAction<State[StateKey]>,\n  ) => {\n    if (process.env.NODE_ENV !== 'production') {\n      validateStateKey(keys, stateKey as string);\n    }\n    const updater = (previousState: State): State => ({\n      ...previousState,\n      [stateKey]: updateValue(previousState[stateKey], update),\n    });\n    if (linkedDispatch) {\n      linkedDispatch({ type: UPDATE_STATE, [PROP_UPDATER]: updater });\n    } else {\n      globalState = updater(globalState);\n      const nextPartialState = globalState[stateKey];\n      listeners[stateKey].forEach((listener) => listener(nextPartialState));\n    }\n  };\n\n  const notifyListeners = (prevState: State, nextState: State) => {\n    keys.forEach((key) => {\n      const nextPartialState = nextState[key as StateKeys];\n      if (prevState[key as StateKeys] !== nextPartialState) {\n        listeners[key as StateKeys].forEach((listener) => listener(nextPartialState));\n      }\n    });\n  };\n\n  const useGlobalStateProvider = () => {\n    const [state, dispatch] = useReducer(patchedReducer, globalState);\n    useEffect(() => {\n      if (linkedDispatch) throw new Error('Only one global state provider is allowed');\n      linkedDispatch = dispatch;\n      // in case it's changed before this effect is handled\n      dispatch({ type: UPDATE_STATE, [PROP_STATE]: globalState });\n      const cleanup = () => {\n        linkedDispatch = null;\n      };\n      return cleanup;\n    }, []);\n    const prevGlobalState = useRef(state);\n    notifyListeners(prevGlobalState.current, state);\n    prevGlobalState.current = state;\n    useEffect(() => {\n      globalState = state;\n    }, [state]);\n  };\n\n  const useGlobalState = <StateKey extends StateKeys>(stateKey: StateKey) => {\n    if (process.env.NODE_ENV !== 'production') {\n      validateStateKey(keys, stateKey as string);\n    }\n    const [partialState, setPartialState] = useState(globalState[stateKey]);\n    useEffect(() => {\n      listeners[stateKey].add(setPartialState);\n      setPartialState(globalState[stateKey]); // in case it's changed before this effect is handled\n      const cleanup = () => {\n        listeners[stateKey].delete(setPartialState);\n      };\n      return cleanup;\n    }, [stateKey]);\n    const updater = useCallback(\n      (u: SetStateAction<State[StateKey]>) => setGlobalState(stateKey, u),\n      [stateKey],\n    );\n    return [partialState, updater] as const;\n  };\n\n  const getGlobalState = <StateKey extends StateKeys>(stateKey: StateKey) => {\n    if (process.env.NODE_ENV !== 'production') {\n      validateStateKey(keys, stateKey as string);\n    }\n    return globalState[stateKey];\n  };\n\n  const getWholeState = () => globalState;\n\n  const setWholeState = (nextGlobalState: State) => {\n    if (linkedDispatch) {\n      linkedDispatch({ type: UPDATE_STATE, [PROP_STATE]: nextGlobalState });\n    } else {\n      const prevGlobalState = globalState;\n      globalState = nextGlobalState;\n      notifyListeners(prevGlobalState, globalState);\n    }\n  };\n\n  const dispatchAction = (action: Action) => {\n    if (linkedDispatch) {\n      linkedDispatch(action);\n    } else {\n      const prevGlobalState = globalState;\n      globalState = reducer(globalState, action);\n      notifyListeners(prevGlobalState, globalState);\n    }\n    return action;\n  };\n\n  return {\n    useGlobalStateProvider,\n    useGlobalState,\n    getGlobalState,\n    setGlobalState,\n    getState: getWholeState,\n    setState: setWholeState, // for devtools.js\n    dispatch: dispatchAction,\n  };\n};\n","import { createContainer } from './createContainer';\n\ntype ExportFields =\n  | 'useGlobalStateProvider'\n  | 'useGlobalState'\n  | 'getGlobalState'\n  | 'setGlobalState';\n\n/**\n * create a gloal state\n *\n * It returns a set of functions\n * - `useGlobalState`: a custom hook works like React.useState\n * - `getGlobalState`: a function to get a global state by key outside React\n * - `setGlobalState`: a function to set a global state by key outside React\n *\n * @example\n * import { createGlobalState } from 'react-hooks-global-state';\n *\n * const { useGlobalState } = createGlobalState({ count: 0 });\n *\n * const Component = () => {\n *   const [count, setCount] = useGlobalState('count');\n *   ...\n * };\n */\nexport const createGlobalState = <State>(initialState: State) => {\n  const store = createContainer((state: State, _action: never) => state, initialState);\n  return store as Pick<typeof store, ExportFields>;\n};\n","import { Reducer } from 'react';\n\nimport { createContainer } from './createContainer';\n\ntype Enhancer<Creator> = (creator: Creator) => Creator;\n\ntype ExportFields =\n  | 'useGlobalStateProvider'\n  | 'useGlobalState'\n  | 'getState'\n  | 'dispatch';\n\n/**\n * create a global store\n *\n * In additon to `useGlobaState` which is the same hook as in createGlobalState,\n * a store has `getState` and `dispatch`.\n * A store works somewhat similarly to Redux, but not the same.\n *\n * @example\n * import { createStore } from 'react-hooks-global-state';\n *\n * const initialState = { count: 0 };\n * const reducer = ...;\n *\n * const store = createStore(reducer, initialState);\n * const { useGlobalState } = store;\n *\n * const Component = () => {\n *   const [count, setCount] = useGlobalState('count');\n *   ...\n * };\n */\nexport const createStore = <State, Action>(\n  reducer: Reducer<State, Action>,\n  /* eslint-disable @typescript-eslint/no-explicit-any */\n  initialState: State = (reducer as any)(undefined, { type: undefined }),\n  enhancer?: Enhancer<any>,\n  /* eslint-enable @typescript-eslint/no-explicit-any */\n) => {\n  if (enhancer) return enhancer(createStore)(reducer, initialState) as never;\n  const store = createContainer(reducer, initialState);\n  return store as Pick<typeof store, ExportFields>;\n};\n","/* eslint @typescript-eslint/no-explicit-any: off */\n\nconst compose = (...fns: any[]) => fns.reduce((p, c) => (...args: any[]) => p(c(...args)));\n\nconst initAction = () => ({ type: '@@redux/INIT' });\n\nconst createEnhancers = () => {\n  let savedReducer: any;\n  let savedInitialState: any;\n  const before = (createStore: any) => (reducer: any, initialState: any, enhancer: any) => {\n    savedReducer = reducer;\n    savedInitialState = initialState;\n    if (enhancer) return enhancer(createStore)(reducer, initialState);\n    const store = createStore(reducer, initialState);\n    return {\n      ...store,\n      useGlobalState: (stateKey: any) => {\n        const [value] = store.useGlobalState(stateKey);\n        const MESG = 'Update is not allowed when using DevTools';\n        return [value, () => { throw new Error(MESG); }];\n      },\n    };\n  };\n  const after = (createStore: any) => (reducer: any, initialState: any, enhancer: any) => {\n    if (enhancer) return enhancer(createStore)(reducer, initialState);\n    const store = createStore(savedReducer, savedInitialState);\n    let devState = {\n      ...reducer(initialState, initAction()),\n      ...savedInitialState,\n    };\n    const getState = () => devState;\n    const listeners: any = [];\n    const dispatch = (action: any) => {\n      devState = reducer(devState, action);\n      store.setState(devState.computedStates[devState.currentStateIndex].state);\n      listeners.forEach((f: any) => f());\n      return action;\n    };\n    const subscribe = (listener: any) => {\n      listeners.push(listener);\n      const unsubscribe = () => {\n        const index = listeners.indexOf(listener);\n        listeners.splice(index, 1);\n      };\n      return unsubscribe;\n    };\n    return {\n      ...store,\n      getState,\n      dispatch,\n      subscribe,\n    };\n  };\n  return { before, after };\n};\n\nexport const reduxDevToolsExt = () => {\n  if (!(window as any).__REDUX_DEVTOOLS_EXTENSION__) return (f: any) => f;\n  const { before, after } = createEnhancers();\n  return compose(\n    before,\n    (window as any).__REDUX_DEVTOOLS_EXTENSION__(),\n    after,\n  );\n};\n"],"names":["validateStateKey","keys","stateKey","includes","Error","UPDATE_STATE","process","env","NODE_ENV","Symbol","createContainer","reducer","initialState","Object","globalState","linkedDispatch","listeners","forEach","key","Set","patchedReducer","state","action","type","setGlobalState","update","updater","previousState","[object Object]","oldValue","newValue","r","nextPartialState","listener","notifyListeners","prevState","nextState","useGlobalStateProvider","dispatch","useReducer","useEffect","e","prevGlobalState","useRef","current","useGlobalState","partialState","setPartialState","useState","add","delete","useCallback","u","getGlobalState","getState","setState","nextGlobalState","createGlobalState","_action","createStore","undefined","enhancer","reduxDevToolsExt","window","__REDUX_DEVTOOLS_EXTENSION__","f","before","after","savedReducer","savedInitialState","store","value","devState","computedStates","currentStateIndex","subscribe","push","index","indexOf","splice","createEnhancers","fns","reduce","p","c","args","compose"],"mappings":"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"}